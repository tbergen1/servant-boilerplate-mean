angular.module("appDashboard",["ngResource","ui.router"]),angular.module("appDashboard").run(["$rootScope","$timeout","$interval","$state","ServantAngularService","Application",function(e,n,t,r,s,a){e.s={},e.$on("$stateChangeError",function(n,t,s,a,o,i){switch(e.s.loading=!1,i){case"no_subscription":return r.go("plan",s);case"no_number":return r.go("number",s);default:return r.go("servants")}}),e.s.initializeServantSDK=function(n){var t={application_client_id:"none",token:e.s.user.servant_access_token_limited,protocol:window.location.host.indexOf("localhost")>-1?"http":"https",image_dropzone_class:"image-dropzone"};Servant.initialize(t,function(){return n()})},e.s.loadUserAndServantDataFromApp=function(n){a.show_user(null,function(t){return e.s.user=t,console.log("User And Servants Fetched: ",e.s.user),n(null,e.s.user)},function(e){return 401===e.status?(window.location="/",!1):n(e,null)})},e.s.loadUserAndServantDataFromServant=function(n){s.getUserAndServants().then(function(t){for(i=0;i<e.s.user.servants.length;i++)for(j=0;j<t.servants.length;j++)e.s.user.servants[i].servant_id===t.servants[j]._id&&(e.s.user.servants[i].master=t.servants[j].master,e.s.user.servants[i].master_biography=t.servants[j].master_biography,e.s.user.servants[i].personality=t.servants[j].personality,e.s.user.servants[i].servant_pay_subscription_status=t.servants[j].servant_pay_subscription_status,e.s.user.servants[i].servant_pay_subscription_plan_canceled=t.servants[j].servant_pay_subscription_plan_canceled,e.s.user.servants[i].servant_pay_subscription_plan_id=t.servants[j].servant_pay_subscription_plan_id);return n?n():void 0},function(e){console.log(e)})},e.s.reloadUserAndServantData=function(n){e.s.loadUserAndServantDataFromApp(function(t){return t?n(t,null):void e.s.loadUserAndServantDataFromServant(function(t){return t?n(t,null):n?n(null,e.s.user):void 0})})},e.s.setServant=function(n,t){for(i=0;i<e.s.user.servants.length;i++)e.s.user.servants[i].servant_id.toString()===n&&(e.servant_index=i);return s.setServant(e.s.user.servants[e.servant_index].servant_id),t()},e.s.authorizeView=function(n){return n("none"===e.s.user.servants[e.servant_index].servant_pay_subscription_status?"no_subscription":e.s.user.servants[e.servant_index].twilio_phone_number?null:"no_number")},e.s.showModal=function(n){document.getElementById("modal-overlay").style.display="block",document.getElementById("modal-box").style.display="block",e.view=n},e.s.hideModal=function(){document.getElementById("modal-overlay").style.display="none",document.getElementById("modal-box").style.display="none",e.view="dashboard"}}]),angular.module("appDashboard").config(["$stateProvider","$urlRouterProvider",function(e,n){n.otherwise("/"),e.state("servants",{url:"/",templateUrl:"views/dashboard/servants.html",resolve:{setupView:setupView}}).state("plan",{url:"/:servantID/plan",templateUrl:"views/dashboard/plan.html",resolve:{setupView:setupView}}).state("number",{url:"/:servantID/number",templateUrl:"views/dashboard/number.html",resolve:{setupView:setupView}}).state("menu",{url:"/:servantID/menu",templateUrl:"views/dashboard/menu.html",resolve:{setupView:setupView}}).state("blast",{url:"/:servantID/blast",templateUrl:"views/dashboard/blast.html",resolve:{setupView:setupView}})}]);var setupView=["$q","$rootScope","$state","$stateParams","Application","ServantAngularService",function(e,n,t,r){var s=this;if(n.s.user){if(r.servantID&&["menu","blast"].indexOf(s.self.name)>-1){var a=e.defer();return n.s.loading=!0,n.s.setServant(r.servantID,function(){n.s.authorizeView(function(e){return e?a.reject(e):(n.s.loading=!1,a.resolve())})}),a.promise}return!0}var a=e.defer();return n.s.loading=!0,n.s.loadUserAndServantDataFromApp(function(){n.s.initializeServantSDK(function(){n.s.loadUserAndServantDataFromServant(function(){return r.servantID?void n.s.setServant(r.servantID,function(){n.s.authorizeView(function(e){return console.log(e),e?a.reject(e):(n.s.loading=!1,a.resolve())})}):(n.s.loading=!1,a.resolve())})})}),a.promise}];angular.module("appDashboard").config(["$locationProvider",function(e){e.hashPrefix("!")}]),angular.module("appDashboard").controller("BlastController",["$rootScope","$scope","$timeout","$interval","$state","Application","ServantAngularService",function(e,n,t,r,s,a,o){n.initialize=function(){n.view="tinytext",n.tinytexts=[],n.tinytext,n.more_results=!0,n.page=1,n.blast_date=moment(),n.blast_date.diff(moment(),"minutes")&&(n.blast_date=moment()),r(function(){n.blast_date.diff(moment(),"minutes")&&(n.blast_date=moment())},6e4),n.loadTinyTexts(),$("#tiny-text-container").scroll(function(){var e=$("#tiny-text-container")[0].scrollHeight-($("#tiny-text-container").scrollTop()+$("#tiny-text-container").height());$("#tiny-text-container").scrollTop()>100&&100>e&&n.more_results&&!n.loading_infinitescroll&&(n.loading_infinitescroll=!0,n.page=n.page+1,n.loadTinyTexts(n.page,function(){t(function(){n.loading_infinitescroll=!1},250)}))})},n.selectTinyText=function(e){n.view="schedule",n.tinytext=e},n.scheduleTask=function(){n.scheduling=!0,a.scheduleTask({servantID:e.s.user.servants[e.servant_index].servant_id},{scheduled_time:n.blast_date.toDate(),tinytextID:n.tinytext._id,task:"sms_blast_single"},function(e){n.scheduled_time=moment(e.scheduled_time),n.view="scheduled",n.scheduling=!1},function(e){console.log(e)})},n.loadTinyTexts=function(e,t){o.archetypesRecent("tinytext",e).then(function(e){return n.tinytexts=n.tinytexts.concat(e.records),console.log("Tiny Texts Fetched: ",n.tinytexts),e.records.length<10&&(n.more_results=!1),t?t():void 0},function(e){return console.log(e),t?t():void 0})},n.adjustDate=function(e,t){"up"===t&&n.blast_date.add(1,e),"down"===t&&n.blast_date.subtract(1,e),n.blast_date.diff(moment(),"minutes")<0&&(n.blast_date=moment()),n.blast_date.diff(moment(),"days")>59&&(n.blast_date=moment().add(60,"days"))}}]),angular.module("appDashboard").controller("DashboardController",["$rootScope","$scope","$timeout","$state","Application","ServantAngularService",function(e,n){n.showModal=function(n){document.getElementById("modal-overlay").style.display="block",document.getElementById("modal-box").style.display="block",e.view=n},n.hideModal=function(){document.getElementById("modal-overlay").style.display="none",document.getElementById("modal-box").style.display="none",e.view="dashboard"}}]),angular.module("appDashboard").controller("NumberController",["$rootScope","$scope","$timeout","$state","Application","ServantAngularService",function(e,n,t,r,s){n.number_type="local",n.country="US",n.area_code="424",n.initialize=function(){return"none"===e.s.user.servants[e.servant_index].servant_pay_subscription_status?r.go("plan",{servantID:e.s.user.servants[e.servant_index].servant_id}):void 0},n.searchPhoneNumbers=function(){n.searching=!0,s.searchPhoneNumbers({servantID:e.s.user.servants[e.servant_index].servant_id},{number_type:n.number_type,country:n.country,area_code:n.area_code},function(e){n.phone_numbers=e.available_phone_numbers,n.searching=!1},function(e){console.log(e),n.phone_numbers=[],n.searching=!1})},n.purchasePhoneNumber=function(a){var o=confirm("Is this the number you want: "+a+"?  This number will be yours as long as you have a plan with us.  If you cancel your plan, this number will be lost forever, so be careful!");o&&(n.registering=!0,s.purchasePhoneNumber({servantID:e.s.user.servants[e.servant_index].servant_id},{phone_number:a},function(){e.s.reloadUserAndServantData(function(){n.registering=!1,n.registered=!0,t(function(){return n.registered=!1,r.go("menu",{servantID:e.s.user.servants[e.servant_index].servant_id})},3e3)})},function(e){console.log(e)}))},n.releasePhoneNumber=function(){var t=confirm("WARNING: If you release your phone number you will NEVER be able to recover it.  Are you sure you want to release this phone number?");t&&(n.releasing=!0,s.releasePhoneNumber({servantID:e.s.user.servants[e.servant_index].servant_id},{},function(){e.s.reloadUserAndServantData(function(){n.releasing=!1})},function(e){return console.log(e),!1}))}}]),angular.module("appDashboard").controller("PlanController",["$rootScope","$scope","$timeout","$state","Application","ServantAngularService",function(e,n,t,r,s,a){n.newPlan="plan1",e.s.user.servants[e.servant_index].servant_pay_subscription_plan_id&&(n.newPlan=e.s.user.servants[e.servant_index].servant_pay_subscription_plan_id),n.plans=[{label:"500 Text Messages for $12/Month",plan_id:"plan1"},{label:"1000 Text Messages for $24/Month",plan_id:"plan2"},{label:"1500 Text Messages for $36/Month",plan_id:"plan3"},{label:"2000 Text Messages for $48/Month",plan_id:"plan4"},{label:"2500 Text Messages for $60/Month",plan_id:"plan5"},{label:"test",plan_id:"test"}],n.initialize=function(){},n.subscribe=function(){if(n.subscribing=!0,"active"===e.s.user.servants[e.servant_index].servant_pay_subscription_status){if(n.newPlan===e.s.user.servants[e.servant_index].servant_pay_subscription_plan_id)return!1;a.servantpaySubscriptionUpdate(n.newPlan).then(function(){return n.subscribing=!1,n.subscribed=!0,t(function(){return n.subscribed=!1,r.go("menu",{servantID:e.s.user.servants[e.servant_index].servant_id})},3e3),e.s.reloadUserAndServantData()},function(e){console.log(e)})}else a.servantpaySubscriptionCreate(n.newPlan).then(function(){return n.subscribing=!1,n.subscribed=!0,t(function(){return n.subscribed=!1,r.go("menu",{servantID:e.s.user.servants[e.servant_index].servant_id})},3e3),e.s.reloadUserAndServantData()},function(e){console.log(e)})},n.cancelPlan=function(){var t=confirm("WARNING: If you cancel, you will lose your phone number and never be able to recover it.  Are you sure you want to cancel?");t&&(n.canceling=!0,a.servantpaySubscriptionCancel().then(function(){e.s.user.servants[e.servant_index].twilio_phone_number_sid?s.releasePhoneNumber({servantID:e.s.user.servants[e.servant_index].servant_id},{},function(){e.s.reloadUserAndServantData(function(){n.canceling=!1})},function(e){return console.log(e),!1}):e.s.reloadUserAndServantData(function(){n.canceling=!1})},function(e){console.log(e)}))}}]),angular.module("appDashboard").factory("Application",["$resource",function(e){return e("",null,{show_user:{method:"GET",isArray:!1,url:"/user"},searchPhoneNumbers:{method:"POST",isArray:!1,url:"/servants/:servantID/twilio/phone_numbers/search"},purchasePhoneNumber:{method:"POST",isArray:!1,url:"/servants/:servantID/twilio/phone_numbers/purchase"},releasePhoneNumber:{method:"GET",isArray:!1,url:"/servants/:servantID/twilio/phone_numbers/release"},scheduleTask:{method:"POST",isArray:!1,url:"/servants/:servantID/schedule/task"}})}]),angular.module("appDashboard").service("ServantAngularService",["$rootScope","$q",function(e,n){this.status=function(){return Servant.status},this.connect=function(){Servant.connect()},this.getUserAndServants=function(){var e=n.defer();return Servant.getUserAndServants(function(n){e.resolve(n)},function(n){e.reject(n)}),e.promise},this.showServant=function(e){var t=n.defer();return Servant.showServant(e,function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise},this.setServant=function(e){var t=n.defer();return Servant.setServant(e),t.resolve(),t.promise},this.initializeUploadableArchetypes=function(e){var t=n.defer();return Servant.initializeUploadableArchetypes(e),t.resolve(),t.promise},this.instantiate=function(e){var t=n.defer();return Servant.instantiate(e,function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise},this.validate=function(e,t){var r=n.defer();return Servant.validate(e,t,function(e,n){e&&r.resolve(e),n&&r.resolve(n)},function(e){r.reject(e)}),r.promise},this.saveArchetype=function(e,t){var r=n.defer();return Servant.saveArchetype(e,t,function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.showArchetype=function(e,t){var r=n.defer();return Servant.showArchetype(e,t,function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.queryArchetypes=function(e,t){var r=n.defer();return Servant.queryArchetypes(e,t,function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.deleteArchetype=function(e,t){var r=n.defer();return Servant.deleteArchetype(e,t,function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.archetypesRecent=function(e,t){var r=n.defer();return Servant.archetypesRecent(e,t,function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.archetypesOldest=function(e,t){var r=n.defer();return Servant.archetypesOldest(e,t,function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.servantpayCharge=function(e){var t=n.defer();return Servant.servantpayCharge(e,function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise},this.servantpaySubscriptionCreate=function(e){var t=n.defer();return Servant.servantpaySubscriptionCreate(e,function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise},this.servantpaySubscriptionUpdate=function(e){var t=n.defer();return Servant.servantpaySubscriptionUpdate(e,function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise},this.servantpaySubscriptionCancel=function(){var e=n.defer();return Servant.servantpaySubscriptionCancel(function(n){e.resolve(n)},function(n){e.reject(n)}),e.promise},this.servantpayCustomerDelete=function(){var e=n.defer();return Servant.servantpayCustomerDelete(function(n){e.resolve(n)},function(n){e.reject(n)}),e.promise}}]);